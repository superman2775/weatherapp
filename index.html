<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cool Weather Map App</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #f0f4f8; }
    #app { display: flex; height: 100vh; }
    #map { flex: 2; }
    #sidebar { flex: 1; padding: 1rem; overflow-y: auto; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
    button { padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0.25rem; }
    button:hover { background: #0056b3; }
    .current { font-size: 1.2rem; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; }
    .day { border-bottom: 1px solid #eee; padding: 0.75rem 0; }
    .day:last-child { border-bottom: none; }
    #chart-container { height: 200px; margin: 1rem 0; }
    .wind-compass { width: 80px; height: 80px; border: 4px solid #ddd; border-radius: 50%; margin: 0.5rem auto; position: relative; }
    .wind-arrow { position: absolute; top: 50%; left: 50%; transform-origin: left center; width: 40px; height: 4px; background: #ff6b6b; transform: translateX(-50%) translateY(-50%); }
    .wind-arrow::after { content: ''; position: absolute; right: -8px; top: -4px; width: 0; height: 0; border-left: 8px solid #ff6b6b; border-top: 4px solid transparent; border-bottom: 4px solid transparent; }
    #loading { text-align: center; color: #666; }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>
    <div id="sidebar">
      <button id="geolocate">üìç My Location</button>
      <div id="current"></div>
      <div id="chart-container"><canvas id="temp-chart"></canvas></div>
      <h3>10-Day Forecast</h3>
      <div id="forecast"></div>
      <div id="loading" style="display: none;">Loading weather...</div>
    </div>
  </div>
  <script>
    // Initialize map with OpenStreetMap
    const map = L.map('map').setView([50.85, 4.35], 10); // Asse, Belgium
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    let marker = L.marker([50.85, 4.35]).addTo(map);
    let chart = null;
    
    // Fetch weather from Open-Meteo (free, no key needed)
    async function fetchWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,apparent_temperature,precipitation_probability,wind_speed_10m,wind_direction_10m,wind_gusts_10m&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,wind_speed_10m_max,wind_direction_10m_dominant,sunrise,sunset&timezone=auto&forecast_days=10`;
      
      const res = await fetch(url);
      if (!res.ok) throw new Error('Weather fetch failed');
      return res.json();
    }
    
    // Wind direction to text (N, NE, etc.)
    function windDirToText(deg) {
      const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
      return dirs[Math.round(deg / 22.5) % 16];
    }
    
    // Update UI with weather data
    async function updateWeather(lat, lon) {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('current').innerHTML = '';
      
      try {
        const data = await fetchWeather(lat, lon);
        
        // Current (first hour)
        const currentIdx = 0;
        const temp = data.hourly.temperature_2m[currentIdx];
        const feels = data.hourly.apparent_temperature[currentIdx];
        const wind = data.hourly.wind_speed_10m[currentIdx];
        const windDir = data.hourly.wind_direction_10m[currentIdx];
        const gusts = data.hourly.wind_gusts_10m[currentIdx] || 0;
        
        document.getElementById('current').innerHTML = `
          <div>Temperature: ${Math.round(temp)}¬∞C (feels ${Math.round(feels)}¬∞C)</div>
          <div>Wind: ${Math.round(wind)} m/s ${windDirToText(windDir)} (${windDir}¬∞)</div>
          <div>Gusts: ${Math.round(gusts)} m/s</div>
          <div class="wind-compass" style="transform: rotate(${windDir}deg);">
            <div class="wind-arrow"></div>
          </div>
        `;
        
        // Next 24h temp chart
        const labels = data.hourly.time.slice(0, 24).map(t => new Date(t).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
        const temps = data.hourly.temperature_2m.slice(0, 24);
        const ctx = document.getElementById('temp-chart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Temp (¬∞C)', data: temps, borderColor: '#007bff', tension: 0.4 }] },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
        });
        
        // 10-day forecast
        let forecastHtml = '';
        for (let i = 0; i < 10; i++) {
          const date = new Date(data.daily.time[i]);
          const dayName = date.toLocaleDateString('en', { weekday: 'short', month: 'short', day: 'numeric' });
          forecastHtml += `
            <div class="day">
              <div><strong>${dayName}</strong></div>
              <div>Min: ${Math.round(data.daily.temperature_2m_min[i])}¬∞ Max: ${Math.round(data.daily.temperature_2m_max[i])}¬∞</div>
              <div>Wind: ${Math.round(data.daily.wind_speed_10m_max[i])} m/s ${windDirToText(data.daily.wind_direction_10m_dominant[i])}</div>
              <div>Rain: ${data.daily.precipitation_probability_max[i]}%</div>
            </div>
          `;
        }
        document.getElementById('forecast').innerHTML = forecastHtml;
        
      } catch (error) {
        document.getElementById('current').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
    
    // Map click handler
    map.on('click', e => {
      const { lat, lng } = e.latlng;
      marker.setLatLng([lat, lng]);
      map.panTo([lat, lng]);
      updateWeather(lat, lng);
    });
    
    // Geolocation button
    document.getElementById('geolocate').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude: lat, longitude: lon } = pos.coords;
          marker.setLatLng([lat, lon]);
          map.panTo([lat, lon]);
          updateWeather(lat, lon);
        }, console.error, { enableHighAccuracy: true });
      }
    });
    
    // Load initial weather
    updateWeather(50.85, 4.35);

  </script>
</body>
</html>
